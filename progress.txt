## Progress Log - StackCloud CSS 3D Sphere Refactor

### 2026-01-15 - RESEARCH_001 Complete

**Task:** Research CSS 3D sphere positioning algorithms

**What was done:**
1. Researched Fibonacci sphere (Golden Spiral) algorithm for even point distribution
2. Studied improved epsilon offset technique that improves packing by 8.3%
3. Researched CSS 3D transform mapping (rotateY, rotateX, translateZ)
4. Documented GPU acceleration best practices

**Key findings:**
- Golden angle = π(3 - √5) ≈ 137.508° - creates spiral pattern that never aligns into rows
- Improved distribution uses epsilon offset to push points away from poles:
  - n < 24: ε = 0.33
  - n < 177: ε = 1.33
  - n < 890: ε = 3.33
  - n ≥ 890: ε = 10
- CSS transforms (rotateY, rotateX, translateZ) run on compositor thread = 60fps smooth

**Output:**
- Created `src/components/stack-sphere/use-sphere-positions.ts` with:
  - Comprehensive algorithm documentation in JSDoc comments
  - `calculateSpherePositions()` function implementing Fibonacci sphere with epsilon offset
  - `useSpherePositions()` React hook for memoized position calculation
  - Full type definitions for SpherePosition

**References documented:**
- https://extremelearning.com.au/how-to-evenly-distribute-points-on-a-sphere-more-effectively-than-the-canonical-fibonacci-lattice/
- https://www.cssscript.com/3d-rotating-sphere-tags-cloud/
- https://www.smashingmagazine.com/2016/12/gpu-animation-doing-it-right/

**Status:** PASSES

---

### 2026-01-15 - SETUP_001 Complete

**Task:** Create new CSS-only sphere component file structure

**What was done:**
1. Created component shell mirroring StackCloud interface with CSS transforms
2. Implemented StackSphere main component with Suspense wrapper
3. Implemented StackSphereItem component with memoization
4. Created CSS file with perspective, rotation animation, and reduced motion support
5. Created module index with proper exports

**Files created:**
- `src/components/stack-sphere/stack-sphere.tsx` - Main sphere container with auto-rotation
- `src/components/stack-sphere/stack-sphere-item.tsx` - Individual item component with a11y
- `src/components/stack-sphere/stack-sphere.css` - CSS styles with GPU acceleration hints
- `src/components/stack-sphere/index.tsx` - Module exports

**Key implementation details:**
- Used existing `useSpherePositions` hook from RESEARCH_001
- Reused `extractUniqueStacks()` and `calculateStackSizeFactors()` utilities
- Integrated `useAccessibility` hook for consistent a11y support
- Applied CSS containment (`contain: paint`) for repaint isolation
- Added `will-change: auto` with conditional GPU hints
- Implemented reduced motion media query support
- Added proper ARIA attributes (aria-label, aria-pressed, role)

**Preserved files (unchanged):**
- `src/data/projects.ts`
- `src/utils/stack-cloud/calculate-stack-size.ts`
- `src/utils/extract-stacks.ts`

**Status:** PASSES

---

### 2026-01-15 - A11Y_002 Complete

**Task:** Implement keyboard navigation with roving tabindex

**What was done:**
1. Integrated existing `useRovingTabindex` hook into StackSphere component
2. Updated StackSphereItem to use `forwardRef` for focus management
3. Connected keyboard event handlers for arrow key navigation
4. Wired up tabIndex from roving tabindex hook to each item

**Files modified:**
- `src/components/stack-sphere/stack-sphere.tsx` - Added useRovingTabindex integration
- `src/components/stack-sphere/stack-sphere-item.tsx` - Added forwardRef, external keydown handler

**Key implementation details:**
- Single tab stop: only one item has tabIndex=0 at a time, rest are -1
- Arrow keys (all directions) navigate between items with loop enabled
- Enter/Space selects the focused item (triggers URL filter)
- Focus ring already styled in CSS via `:focus-visible::after`
- Tab/Shift+Tab escapes the sphere to next focusable element (WAI-ARIA APG compliant)

**Accessibility features:**
- Roving tabindex pattern per WAI-ARIA APG keyboard interface guidelines
- Home/End keys jump to first/last items
- Focus automatically follows active index when using arrow keys
- Focus ring visible only on keyboard focus (not mouse)

**Status:** PASSES

---

### 2026-01-15 - SEGMENT_001 Complete

**Task:** Add domain segment indicators around sphere

**What was done:**
1. Created StackSphereSegment component for domain labels
2. Positioned 6 domain segments around sphere perimeter
3. Wired click handlers to filter by domain via URL params
4. Added hover state that highlights all items matching hovered domain

**Files created:**
- `src/components/stack-sphere/stack-sphere-segment.tsx` - Domain segment button component

**Files modified:**
- `src/components/stack-sphere/stack-sphere.tsx` - Added segments, domain hover state
- `src/components/stack-sphere/stack-sphere.css` - Added segment hover/focus styles

**Key implementation details:**
- Segments positioned absolutely around sphere container at cardinal/intercardinal points
- Uses existing `toggleFilterParam()` for URL-based domain filtering
- `hoveredDomain` state propagates to StackSphereItem's `highlighted` prop
- Domain-specific border colors via `useAccessibility().getBorderColor()`
- Keyboard accessible with focus ring styling
- Reduced motion support for transition disabling

**Acceptance criteria met:**
- Domain segments visible around sphere (6 segments rendered)
- Click segment filters to that domain (toggles `?filter=DevOps` etc.)
- Segment hover highlights related items (sets `data-highlighted=true`)

**Status:** PASSES

---

### 2026-01-15 - CENTER_001 Complete

**Task:** Add center experience display

**What was done:**
1. Created StackSphereExperience component for center display
2. Integrated into StackSphere (positioned absolutely, doesn't rotate)
3. Added CSS positioning styles for centering

**Files created:**
- `src/components/stack-sphere/stack-sphere-experience.tsx` - Center experience display

**Files modified:**
- `src/components/stack-sphere/stack-sphere.tsx` - Added experience component, track full stack info on hover
- `src/components/stack-sphere/stack-sphere.css` - Added .stack-sphere-experience positioning

**Key implementation details:**
- Reuses existing `ExperienceTicker` component for animated number transitions
- Shows total experience by default (with ChartPie icon)
- Shows stack-specific experience on item hover (with stack icon + name)
- Shows domain-specific experience on domain segment hover (with domain icon + name)
- Uses `adjustExperience()` to round long tenures appropriately
- Positioned at sphere center via absolute positioning (doesn't rotate with sphere)
- pointer-events: none to not interfere with sphere item clicks

**Acceptance criteria met:**
- Center shows total experience by default
- Hover shows stack-specific experience
- Experience ticker animates on change (via ExperienceTicker)

**Status:** PASSES

---

### 2026-01-15 - CLEANUP_001 Complete

**Task:** Remove D3 dependency and old StackCloud files

**What was done:**
1. Deleted old StackCloud component files (stack-cloud.tsx, stack-cloud-content.tsx, stack-cloud-loader.tsx, stack-node.tsx, root-node.tsx, root-node-chart.tsx, root-node-experience.tsx, index.tsx)
2. Deleted D3-dependent hook (use-stack-simulation.ts)
3. Deleted D3-dependent utilities (10 files in utils/stack-cloud/)
4. Deleted D3-related constants (stack-cloud-physics.ts)
5. Deleted D3-dependent types (SimulationNode from simulation.ts)
6. Removed d3 and @types/d3 from package.json
7. Ran npm install to update lockfile (removed 87 packages)
8. Cleaned up newly unused files found by knip (10 additional files)
9. Removed unused type exports and functions

**Files deleted:**
Components:
- `src/components/stack-cloud/stack-cloud.tsx`
- `src/components/stack-cloud/stack-cloud-content.tsx`
- `src/components/stack-cloud/stack-cloud-loader.tsx`
- `src/components/stack-cloud/stack-node.tsx`
- `src/components/stack-cloud/root-node.tsx`
- `src/components/stack-cloud/root-node-chart.tsx`
- `src/components/stack-cloud/root-node-experience.tsx`
- `src/components/stack-cloud/index.tsx`

Hooks:
- `src/hooks/use-stack-simulation.ts`
- `src/hooks/use-dimensions.ts`

Utils:
- `src/utils/stack-cloud/adaptive-physics.ts`
- `src/utils/stack-cloud/boundary-force.ts`
- `src/utils/stack-cloud/calculate-domain-angles.ts`
- `src/utils/stack-cloud/convert-arc-angle.ts`
- `src/utils/stack-cloud/create-forces.ts`
- `src/utils/stack-cloud/distribute-nodes-in-segment.ts`
- `src/utils/stack-cloud/mass-dampen-force.ts`
- `src/utils/stack-cloud/performance-utils.ts`
- `src/utils/stack-cloud/root-exclusion-force.ts`
- `src/utils/stack-cloud/seed-position.ts`
- `src/utils/stack-cloud/calculate-base-radius.ts`
- `src/utils/calculate-domain-size.ts`
- `src/utils/experience-cache.ts`
- `src/utils/get-initial-selection.ts`
- `src/utils/hover-state-manager.ts`
- `src/utils/matches-stack-name.ts`
- `src/utils/math.ts`
- `src/utils/stack-selection.ts`

Constants:
- `src/constants/stack-cloud-physics.ts`
- `src/constants/stack-selection-scale.ts`

Types:
- `src/types/simulation.ts`

**Files preserved (still used by stack-sphere):**
- `src/components/stack-cloud/experience-ticker.tsx`
- `src/utils/stack-cloud/calculate-stack-size.ts`
- `src/utils/stack-cloud/selection-index.ts`

**Acceptance criteria met:**
- D3 not in package.json (removed d3 and @types/d3)
- npm run build succeeds without D3
- Bundle size reduced (removed 87 packages)

**Status:** PASSES

---

### 2026-01-15 - BUG_000 Complete

**Task:** Fix React hydration mismatch in sphere items

**Root cause:**
Server and client JavaScript engines produce slightly different floating-point values for the same Math operations (e.g., 51.16368433036698 vs 51.16368430511891). These raw floats were used directly in inline style props, causing React hydration mismatches.

**What was done:**
1. Added `round()` helper function to round values to 2 decimal places
2. Applied rounding to all floating-point values used in styles:
   - `itemSize` - button width/height
   - `iconSize` - icon dimensions
   - `depthOpacity` - opacity based on z-depth
   - SVG circle `r` attribute for selection indicator
3. Rounded `depth` at source in `useSpherePositions` hook

**Files modified:**
- `src/components/stack-sphere/stack-sphere-item.tsx` - Added round() helper, applied to itemSize, iconSize, depthOpacity, SVG r
- `src/components/stack-sphere/use-sphere-positions.ts` - Rounded depth calculation

**Key insight:**
The `transform` string was already safe (used `.toFixed(2)` since initial implementation), but derived values like `depth`, `itemSize`, `iconSize`, and `depthOpacity` were not rounded.

**Acceptance criteria met:**
- No hydration warnings in console (floating-point values now consistent)
- Sphere renders correctly after hydration

**Status:** PASSES

---

### 2026-01-15 - BUG_001 Complete

**Task:** Fix icon centering within sphere item containers

**What was done:**
1. Added flexbox centering to `.stack-sphere-item` class in CSS
2. Removed wrapper div with absolute positioning from icon in TSX
3. Icon component now directly uses flexbox centering from parent

**Files modified:**
- `src/components/stack-sphere/stack-sphere.css` - Added `display: flex; align-items: center; justify-content: center;` to `.stack-sphere-item`
- `src/components/stack-sphere/stack-sphere-item.tsx` - Removed wrapper div, applied styles directly to IconComponent

**Key changes:**
- Previous: Icon wrapped in div with `position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%)`
- Now: Parent button uses flexbox, icon centered automatically

**Acceptance criteria met:**
- Icons are visually centered in their containers
- Centering works across all item sizes (flexbox centering is size-agnostic)

**Status:** PASSES

---

### 2026-01-15 - BUG_002 Complete

**Task:** Fix icon sizing relative to container size

**Root cause:**
69 of the SVG icons don't have a `viewBox` attribute. Without viewBox, SVGs don't scale their content when width/height attributes are changed - the internal paths stay at 24x24 even when the viewport is larger.

**What was done:**
1. Changed icon sizing to use CSS `transform: scale()` instead of width/height
2. Set base icon size to 24px (matching SVG native size)
3. Calculate scale factor based on container size: `iconScale = (itemSize * 0.7) / 24`
4. Applied scale transform to icon component

**Files modified:**
- `src/components/stack-sphere/stack-sphere-item.tsx` - Changed from `iconSize` width/height to `iconScale` transform

**Key changes:**
- Previous: `<IconComponent width={iconSize} height={iconSize} />` where iconSize varied from 25-84px
- Now: `<IconComponent width={24} height={24} style={{ transform: scale(${iconScale}) }} />` where iconScale varies from ~1.05 to ~3.5

**Why this approach:**
- CSS transform: scale() works regardless of SVG viewBox presence
- Avoids modifying 69 SVG files
- GPU-accelerated, no layout thrashing
- Added transform to transition for smooth hover effects

**Acceptance criteria met:**
- Icons scale with container size (different scale transforms produce different visual sizes)
- Icons maintain aspect ratio at all sizes (scale is uniform x/y)

**Status:** PASSES

---

### 2026-01-15 - HOVER_002 Complete

**Task:** Show experience tooltip on individual item hover

**What was done:**
1. Added `experience` prop to StackSphereItem component
2. Added tooltip span with `.stack-sphere-item-tooltip` class
3. Calculated and memoized experience for each stack in parent component
4. Passed experience data through to each item

**Files modified:**
- `src/components/stack-sphere/stack-sphere-item.tsx` - Added experience prop and tooltip display
- `src/components/stack-sphere/stack-sphere.tsx` - Added experience calculation with useMemo, pass to items

**Key implementation details:**
- Tooltip positioned absolutely below item (`bottom: -1.5rem`)
- Shows years/months format (e.g., "5y 3m", "8m", "< 1m")
- Uses `adjustExperience()` for proper display rounding
- `aria-hidden="true"` since experience is already in center display
- Colored with border color to match item state
- Only shows when `isDirectlyHovered` is true (not domain hover)

**Acceptance criteria met:**
- Hovering item shows experience value near the item (tooltip positioned below)
- Tooltip shows correct experience for each stack (uses calculateStackExperience)

**Status:** PASSES
